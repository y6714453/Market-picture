import asyncio
import os
import datetime
import pytz
import yfinance as yf
import edge_tts
import subprocess
from requests_toolbelt.multipart.encoder import MultipartEncoder
import requests

# ×¤×¨×˜×™ ×”×’×™×©×” ×œ××¢×¨×›×ª ×™××•×ª ×”××©×™×—
USERNAME = "0733181201"
PASSWORD = "6714453"
TOKEN = f"{USERNAME}:{PASSWORD}"
UPLOAD_URL = "https://www.call2all.co.il/ym/api/UploadFile"
UPLOAD_PATH = "ivr2:/2/market.wav"

# ×”××¨×•×ª ××¡×¤×¨×™×
def ××¡×¤×¨_×œ×˜×§×¡×˜(num):
    return str(num).replace('.', ' × Ö°×§×•Ö¼×“Ö¸×” ')

# ×”××¨×ª ×©×¢×”
def ×©×¢×”_×œ×˜×§×¡×˜():
    tz = pytz.timezone('Asia/Jerusalem')
    now = datetime.datetime.now(tz)
    return now.strftime("%H × Ö°×§×•Ö¼×“Ö¸×” %M")

# ×™×¦×™×¨×ª ×˜×§×¡×˜ ×ª××•× ×ª ×©×•×§
async def ×¦×•×¨_×˜×§×¡×˜():
    ×˜×§×¡×˜ = f"×œÖ·×™Ö°×œÖ¸×” ×˜×•Ö¹×‘, ×–×•Ö¹ ×ªÖ°Ö¼××•Ö¼× Ö·×ª ×”Ö·×©Ö¼××•Ö¼×§ × Ö¸×›×•Ö¹×Ÿ ×œÖ°×©Ö¸××¢Ö¸×” {×©×¢×”_×œ×˜×§×¡×˜()}:\n\n"

    # ××“×“×™× ×™×©×¨××œ×™×™×
    ×˜×§×¡×˜ += "×‘Ö°Ö¼×™Ö´×©Ö°×‚×¨Ö¸×Öµ×œ:\n"
    ta125 = yf.Ticker("TA125.TA").history(period="5d")
    ta35 = yf.Ticker("TA35.TA").history(period="5d")

    for ×©×, ××“×“ in [("×ªÖµÖ¼×œ ×Ö¸×‘Ö´×™×‘ ×Öµ×Ö¸×” ×¢Ö¶×©Ö°×‚×¨Ö´×™× ×•Ö°×—Ö¸×Öµ×©×", ta125), ("×ªÖµÖ¼×œ ×Ö¸×‘Ö´×™×‘ ×©Ö°××œ×•Ö¹×©Ö´××™× ×•Ö°×—Ö¸×Öµ×©×", ta35)]:
        if len(××“×“) >= 2:
            ×©×™× ×•×™ = round((××“×“['Close'][-1] - ××“×“['Close'][-2]) / ××“×“['Close'][-2] * 100, 2)
            ×¢×¨×š = round(××“×“['Close'][-1])
            ××’××” = "×¢×•Ö¹×œÖ¶×”" if ×©×™× ×•×™ > 0 else "×™×•Ö¹×¨Öµ×“" if ×©×™× ×•×™ < 0 else "×œÖ°×œÖ¹× ×©Ö´××™× Ö¼×•Ö¼×™"
            ×˜×§×¡×˜ += f"×Ö¸×“Ö¸×“ {×©×} {××’××”} ×‘Ö°Ö¼×©Ö´××¢Ö¼×•Ö¼×¨ ×©Ö¶××œ {××¡×¤×¨_×œ×˜×§×¡×˜(abs(×©×™× ×•×™))} ×Ö¸×—×•Ö¼×–, ×•Ö°×¢×•Ö¹×Öµ×“ ×¢Ö·×œ {××¡×¤×¨_×œ×˜×§×¡×˜(×¢×¨×š)} × Ö°×§×•Ö¼×“×•Ö¹×ª.\n"

    # ××“×“×™× ×××¨×™×§××™×™×
    ×˜×§×¡×˜ += "\n×‘Ö¸Ö¼×¢×•Ö¹×œÖ¸×:\n"
    for ×¡××œ, ×©×_××“×“ in [("^GSPC", "×”Ö¸×Ö·×¡ ×Ö¶× Ö°×“ ×¤Ö´Ö¼×™"), ("^IXIC", "×”Ö·× Ö¸Ö¼××¡Ö°×“Ö¸Ö¼×§"), ("^DJI", "×“Ö¸Ö¼××•Ö¼ ×’'×•Ö¹× Ö°×¡")]:
        ××“×“ = yf.Ticker(×¡××œ).history(period="5d")
        if len(××“×“) >= 2:
            ×©×™× ×•×™ = round((××“×“['Close'][-1] - ××“×“['Close'][-2]) / ××“×“['Close'][-2] * 100, 2)
            ×¢×¨×š = round(××“×“['Close'][-1])
            ××’××” = "×¢×•Ö¹×œÖ¶×”" if ×©×™× ×•×™ > 0 else "×™×•Ö¹×¨Öµ×“" if ×©×™× ×•×™ < 0 else "×œÖ°×œÖ¹× ×©Ö´××™× Ö¼×•Ö¼×™"
            ×˜×§×¡×˜ += f"×Ö¸×“Ö¸×“ {×©×_××“×“} {××’××”} ×‘Ö°Ö¼×©Ö´××¢Ö¼×•Ö¼×¨ ×©Ö¶××œ {××¡×¤×¨_×œ×˜×§×¡×˜(abs(×©×™× ×•×™))} ×Ö¸×—×•Ö¼×–, ×•Ö°×¢×•Ö¹×Öµ×“ ×¢Ö·×œ {××¡×¤×¨_×œ×˜×§×¡×˜(×¢×¨×š)} × Ö°×§×•Ö¼×“×•Ö¹×ª.\n"

    # ××˜×‘×¢×•×ª ×§×¨×™×¤×˜×•
    ×˜×§×¡×˜ += "\n×‘Ö°Ö¼×’Ö´×–Ö°×¨Ö·×ª ×”Ö·×§Ö°Ö¼×¨Ö´×™×¤Ö°Ö¼×˜×•Ö¹:\n"
    for ×¡××œ, ×©× in [("BTC-USD", "×”Ö·×‘Ö´Ö¼×™×˜Ö°×§×•Ö¹×™Ö°×Ÿ"), ("ETH-USD", "×”Ö¸×Ö´×ªÖ¶×¨Ö´×™×•Ö¼×")]:
        ××˜×‘×¢ = yf.Ticker(×¡××œ).history(period="1d")
        if not ××˜×‘×¢.empty:
            ×¢×¨×š = round(××˜×‘×¢['Close'][-1])
            ×˜×§×¡×˜ += f"{×©×} × Ö´×¡Ö°×—Ö¸×¨ ×‘Ö°Ö¼×©Ö·××¢Ö·×¨ ×©Ö¶××œ {××¡×¤×¨_×œ×˜×§×¡×˜(×¢×¨×š)} ×“Ö¼×•Ö¹×œÖ¸×¨.\n"

    # ×“×•×œ×¨ ×œ×©×§×œ
    ×“×•×œ×¨ = yf.Ticker("USDILS=X").history(period="1d")
    if not ×“×•×œ×¨.empty:
        ×©×¢×¨ = round(×“×•×œ×¨['Close'][-1], 2)
        ×©×™× ×•×™ = ×©×¢×¨ - ×“×•×œ×¨['Close'][0]
        ××’××” = "×Ö´×ªÖ°×—Ö·×–ÖµÖ¼×§" if ×©×™× ×•×™ > 0 else "× Ö¶×—Ö°×œÖ¸×©×"
        ×˜×§×¡×˜ += f"\n×”Ö·×“Ö¼×•Ö¹×œÖ¸×¨ {××’××”} ××•Ö¼×œ ×”Ö·×©Ö¶Ö¼××§Ö¶×œ ×•Ö°× Ö´×¡Ö°×—Ö¸×¨ ×‘Ö°Ö¼×©Ö·××¢Ö·×¨ ×©Ö¶××œ {××¡×¤×¨_×œ×˜×§×¡×˜(×©×¢×¨)} ×©Ö°××§Ö¸×œÖ´×™×."

    return ×˜×§×¡×˜

# ×©××™×¨×ª ×§×•×‘×¥ ×§×•×œ
async def ×©××•×¨_×§×•×‘×¥(text):
    tts = edge_tts.Communicate(text, voice="he-IL-AvriNeural")
    await tts.save("market.mp3")
    subprocess.run(["ffmpeg", "-y", "-i", "market.mp3", "-ar", "8000", "-ac", "1", "-acodec", "pcm_s16le", "market.wav"])

# ×”×¢×œ××” ×œ×™××•×ª
def ×”×¢×œ×”_×œ×™××•×ª():
    print("ğŸ“¤ ××¢×œ×” ×§×•×‘×¥ ×œ×™××•×ª ×”××©×™×— ×œ×©×œ×•×—×” 2...")
    with open("market.wav", 'rb') as f:
        m = MultipartEncoder(fields={
            'token': TOKEN,
            'path': UPLOAD_PATH,
            'file': ('market.wav', f, 'audio/wav')
        })
        r = requests.post(UPLOAD_URL, data=m, headers={'Content-Type': m.content_type})
        print("âœ… ×”×•×¢×œ×” ×œ×™××•×ª ×”××©×™×—:", r.text)

# ×”×¨×¦×ª ×”×›×œ
async def main():
    print("ğŸ¤ ××™×™×¦×¨ ×ª××•× ×ª ×©×•×§...")
    ×˜×§×¡×˜ = await ×¦×•×¨_×˜×§×¡×˜()
    print("ğŸ“„ ×˜×§×¡×˜ ×ª××•× ×ª ×©×•×§:\n\n" + ×˜×§×¡×˜ + "\n")
    print("ğŸ”„ ×××™×¨ ×˜×§×¡×˜ ×œ-MP3...")
    await ×©××•×¨_×§×•×‘×¥(×˜×§×¡×˜)
    ×”×¢×œ×”_×œ×™××•×ª()

if __name__ == "__main__":
    asyncio.run(main())
